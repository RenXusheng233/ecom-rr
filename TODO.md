# TODO: 实现自定义 NestJS Auth 模块

## 目标
替换当前的 Clerk 认证方案，实现基于 NestJS 的自定义认证模块。

## 当前状态分析
需要先分析项目中现有的认证实现，了解：
1. 当前如何使用 Clerk
2. 认证流程和集成点
3. 需要替换的组件

## 任务清单

### 阶段 1: 分析现有实现
- [ ] 检查 `packages/types/src/auth.ts` 中的认证类型定义
- [ ] 分析 admin 应用中的认证集成
- [ ] 分析 client 应用中的认证集成
- [ ] 检查是否有其他服务使用认证

### 阶段 2: 设计 NestJS Auth 模块架构
- [ ] 设计 JWT 认证策略
- [ ] 设计用户模型和数据库 schema
- [ ] 设计认证服务 (AuthService)
- [ ] 设计守卫 (Guards) 和装饰器
- [ ] 设计密码加密和验证

### 阶段 3: 实现核心模块
- [ ] 创建 `packages/auth` 包
- [ ] 实现用户模型和数据库迁移
- [ ] 实现 JWT 策略
- [ ] 实现认证服务
- [ ] 实现守卫和装饰器

### 阶段 4: 集成到现有应用
- [ ] 更新 admin 应用使用新的 auth 模块
- [ ] 更新 client 应用使用新的 auth 模块
- [ ] 确保向后兼容性
- [ ] 更新 API 调用

### 阶段 5: 测试和验证
- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 测试认证流程
- [ ] 验证安全性

## 技术栈选择
- **框架**: NestJS
- **数据库**: PostgreSQL (通过 Prisma)
- **认证**: JWT (JSON Web Tokens)
- **密码加密**: bcrypt
- **Session 管理**: Redis (可选)

## 依赖项
- `@nestjs/jwt`
- `@nestjs/passport`
- `passport-jwt`
- `bcrypt`
- `@prisma/client`

## 风险与考虑
1. **数据迁移**: 需要迁移现有用户数据（如果有）
2. **安全性**: 确保密码存储和 JWT 实现安全
3. **性能**: 认证流程不应成为性能瓶颈
4. **向后兼容**: 确保现有 API 调用继续工作
